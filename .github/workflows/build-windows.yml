name: Build Amazon Japan Scraper v5.0

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-v5:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Install Chrome for Selenium
      run: |
        choco install googlechrome -y --force
        
    - name: Test imports for v5.0
      run: |
        python -c "import tkinter; import requests; import bs4; import pandas; import openpyxl; import selenium; import undetected_chromedriver; print('All imports successful for v5.0')"
        
    - name: Test v5.0 Selenium version
      run: |
        python -c "from main_selenium_only import SeleniumOnlyScraper, SeleniumOnlyGUI; print('v5.0 Selenium version imports successful')"
        
    - name: Build v5.0 executable
      run: |
        python build_v5.py
        
    - name: Debug - List dist directory
      run: |
        Write-Host "Contents of dist directory:"
        Get-ChildItem -Path "dist" -Force | Format-Table Name, Length, LastWriteTime
        
    - name: Verify build results
      run: |
        # The build script should have created the release_v5 directory
        if (Test-Path "release_v5") {
          Write-Host "✅ Release directory created by build script"
          Write-Host "📁 Contents of release_v5:"
          Get-ChildItem -Path "release_v5" | Format-Table Name, Length, LastWriteTime
          
          # Check for the expected executable
          $exePath = "release_v5\Amazon_Japan_Scraper_v5.0_Selenium.exe"
          if (Test-Path $exePath) {
            Write-Host "✅ Windows executable found: $exePath"
            $fileInfo = Get-Item $exePath
            Write-Host "📊 File size: $([math]::Round($fileInfo.Length / 1MB, 1)) MB"
          } else {
            Write-Host "❌ Expected executable not found in release directory"
            exit 1
          }
        } else {
          Write-Host "❌ Release directory not created by build script"
          exit 1
        }
        
    - name: Final verification
      run: |
        if (Test-Path "release_v5/Amazon_Japan_Scraper_v5.0_Selenium.exe") {
          Write-Host "🎉 v5.0 Selenium Edition build completed successfully!"
          $size = (Get-Item "release_v5/Amazon_Japan_Scraper_v5.0_Selenium.exe").Length / 1MB
          Write-Host "📊 Final file size: $([math]::Round($size, 1)) MB"
          Write-Host "✅ Ready for distribution"
        } else {
          Write-Host "❌ Final verification failed - executable not found"
          exit 1
        }
        
    - name: Upload v5.0 build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Amazon-Japan-Scraper-v5.0-Selenium
        path: release_v5/
        retention-days: 30
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release_v5/Amazon_Japan_Scraper_v5.0_Selenium.exe
          release_v5/README.txt
        body: |
          ## 🚀 Amazon Japan Scraper v5.0 - Selenium Edition
          
          ### 🎉 v5.0 重大升级 - 纯Selenium实现
          
          **核心改进**:
          - 🌐 **完全基于Selenium** - 使用undetected-chromedriver绕过反爬虫
          - 🎯 **93%卖家识别率** - 大幅提升数据提取成功率
          - 📞 **增强电话提取** - 支持中日双语电话号码格式
          - 🏢 **完整卖家信息** - 公司名、地址、电话、邮箱等
          - 🇨🇳 **中文列名** - Excel表格使用中文列头
          - 💪 **稳定可靠** - 成功绕过Amazon反爬机制
          
          ### 📊 测试数据（基于15个产品实测）
          - **卖家识别率**: 93% (14/15)
          - **地址提取率**: 73% (11/15)
          - **电话提取率**: 20% (3/15) - 取决于卖家是否公开
          - **公司名提取率**: 93% (14/15)
          - **平均速度**: 8-10秒/产品
          
          ### 🆚 版本对比
          | 功能 | v4.0 Ultimate | v5.0 Selenium | 改进 |
          |------|---------------|---------------|------|
          | 核心技术 | HTTP + requests | Selenium + undetected-chromedriver | **突破反爬** |
          | 卖家识别率 | ~60% | 93% | **+55%** |
          | 地址提取率 | ~40% | 73% | **+83%** |
          | 电话提取率 | ~5% | 20% | **+300%** |
          | 稳定性 | 经常503错误 | 稳定运行 | **完全解决** |
          | 搜索成功率 | ~30% | ~95% | **+217%** |
          
          ### 📦 下载说明
          - 下载 `Amazon_Japan_Scraper_v5.0_Selenium.exe` 文件
          - 双击运行即可使用，无需安装
          - 需要Google Chrome浏览器（程序会自动使用无头模式）
          - 支持 Windows 10 及以上版本
          
          ### 🚀 使用方法
          1. 启动程序（首次运行会自动下载ChromeDriver）
          2. 输入商品关键词（如：iPhone 手机壳、口红、行李箱）
          3. 设置搜索页数和产品数量
          4. 点击"开始搜索"
          5. 程序自动搜索并实时保存
          6. 结果保存在 amazon_data/ 文件夹
          
          ### 🎯 核心特性
          - **真浏览器技术**: 使用真实Chrome浏览器，完全模拟人类行为
          - **反爬虫绕过**: undetected-chromedriver技术，成功率95%+
          - **实时保存**: 搜索过程中实时保存，防止数据丢失
          - **智能提取**: 4层提取算法，覆盖各种卖家页面结构
          - **中文友好**: Excel列名全部中文显示
          - **多格式支持**: 支持中国和日本电话号码格式
          
          ### 📊 提取字段
          **产品信息**:
          - 产品标题、价格、评分、ASIN、产品链接
          
          **卖家信息**:
          - 卖家名称、公司名称、电话号码、完整地址
          - 电子邮箱、传真号码、店铺名称、代表姓名（如有）
          
          ### ⚙️ 推荐配置
          - **快速测试**: 1页，10产品（约1-2分钟）
          - **中等规模**: 3页，30产品（约5-8分钟）
          - **大规模**: 5-10页，50-100产品（约15-30分钟）
          
          ### 🛡️ 稳定性保证
          - 智能延迟控制，避免被封
          - 会话管理优化，长期稳定运行
          - 错误自动恢复，单个失败不影响整体
          - 内存自动清理，不会溢出
          
          ### 💡 使用建议
          - 建议每次搜索不超过100个产品，以保证最佳性能
          - 电话号码提取率因卖家隐私设置而异（20%是正常水平）
          - 如需大量数据，建议分批次运行
          - 网络稳定时使用效果最佳
          
          ### ⚠️ 注意事项
          - 首次运行需要下载ChromeDriver（约10-20MB）
          - 程序使用无头Chrome浏览器，不会打开可见窗口
          - 请合理使用，遵守Amazon使用条款
          - 数据仅供学习和研究使用
          
          **🎊 v5.0来了！纯Selenium实现，93%识别率，稳定可靠！**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
