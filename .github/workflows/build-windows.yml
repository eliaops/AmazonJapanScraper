name: Build Amazon Japan Scraper v4.0

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ultimate:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Test imports for ultimate version
      run: |
        python -c "import tkinter; import requests; import bs4; import pandas; import openpyxl; print('All imports successful for v4.0')"
        
    - name: Test ultimate version
      run: |
        python -c "from main_ultimate import UltimateAmazonScraper, UltimateScraperGUI; print('Ultimate version imports successful')"
        
    - name: Build ultimate executable
      run: |
        python build_ultimate.py
        
    - name: Debug - List dist directory
      run: |
        Write-Host "Contents of dist directory:"
        Get-ChildItem -Path "dist" -Force | Format-Table Name, Length, LastWriteTime
        
    - name: Verify build results
      run: |
        # The build script should have created the release_ultimate directory
        if (Test-Path "release_ultimate") {
          Write-Host "âœ… Release directory created by build script"
          Write-Host "ğŸ“ Contents of release_ultimate:"
          Get-ChildItem -Path "release_ultimate" | Format-Table Name, Length, LastWriteTime
          
          # Check for the expected executable
          $exePath = "release_ultimate\Amazon_Japan_Scraper_v4.0_Ultimate.exe"
          if (Test-Path $exePath) {
            Write-Host "âœ… Windows executable found: $exePath"
            $fileInfo = Get-Item $exePath
            Write-Host "ğŸ“Š File size: $([math]::Round($fileInfo.Length / 1MB, 1)) MB"
          } else {
            Write-Host "âŒ Expected executable not found in release directory"
            exit 1
          }
        } else {
          Write-Host "âŒ Release directory not created by build script"
          exit 1
        }
        
    - name: Create README for release
      run: |
        $readmeContent = @"
        # Amazon Japan Scraper v4.0 - ç»ˆæç‰ˆ

        ## ğŸš€ v4.0 ç»ˆæç‰ˆç‰¹æ€§
        - ğŸ” æ‰©å¤§å…³é”®è¯æœç´¢èŒƒå›´ï¼Œæ”¯æŒæ›´å¤šå°å•†å“
        - â™¾ï¸ æ— é™åˆ¶è¿ç»­æœç´¢ï¼Œæƒ³æœå¤šä¹…æœå¤šä¹…
        - ğŸ’¾ å®æ—¶ä¿å­˜åŠŸèƒ½ï¼Œä¸€è¾¹æœç´¢ä¸€è¾¹ä¿å­˜æ•°æ®
        - ğŸ§  å››å±‚æ™ºèƒ½å–å®¶ä¿¡æ¯æå–ç®—æ³•
        - ğŸ–¥ï¸ æ”¯æŒåå°è¿è¡Œï¼Œå¯ä»¥ç¦»å¼€æ¡Œé¢

        ## ğŸš€ ä½¿ç”¨æ–¹æ³•
        1. åŒå‡»è¿è¡Œç¨‹åº
        2. è¾“å…¥æœç´¢å…³é”®è¯ï¼ˆå¦‚ï¼šç”µè„‘ã€ç¬”è®°æœ¬ã€æ‰‹æœºï¼‰
        3. è®¾ç½®é¡µæ•°å’Œäº§å“æ•°é‡
        4. ç‚¹å‡»å¼€å§‹æœç´¢

        ## âš™ï¸ æ¨èé…ç½®
        - å°è§„æ¨¡æµ‹è¯•ï¼š20é¡µï¼Œ100äº§å“
        - ä¸­ç­‰è§„æ¨¡ï¼š50é¡µï¼Œ500äº§å“  
        - å¤§è§„æ¨¡ï¼š100é¡µï¼Œ2000äº§å“

        ## ğŸ›¡ï¸ ç¨³å®šæ€§ä¿è¯
        - åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹20ä¸ªäº§å“
        - å†…å­˜è‡ªåŠ¨æ¸…ç†ï¼Œä¸ä¼šæº¢å‡º
        - é”™è¯¯è‡ªåŠ¨æ¢å¤ï¼Œå•ä¸ªå¤±è´¥ä¸å½±å“æ•´ä½“

        ç‰ˆæœ¬: 4.0.0 - ç»ˆæç‰ˆ
        "@
        $readmeContent | Out-File -FilePath "release_ultimate\README.txt" -Encoding UTF8
        
    - name: Final verification
      run: |
        if (Test-Path "release_ultimate/Amazon_Japan_Scraper_v4.0_Ultimate.exe") {
          Write-Host "ğŸ‰ Ultimate v4.0 build completed successfully!"
          $size = (Get-Item "release_ultimate/Amazon_Japan_Scraper_v4.0_Ultimate.exe").Length / 1MB
          Write-Host "ğŸ“Š Final file size: $([math]::Round($size, 1)) MB"
          Write-Host "âœ… Ready for distribution"
        } else {
          Write-Host "âŒ Final verification failed - executable not found"
          exit 1
        }
        
    - name: Upload ultimate build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Amazon-Japan-Scraper-v4.0-Ultimate
        path: release_ultimate/
        retention-days: 30
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release_ultimate/Amazon_Japan_Scraper_v4.0_Ultimate.exe
          release_ultimate/README.txt
        body: |
          ## ğŸš€ Amazon Japan å–å®¶ä¿¡æ¯æå–å·¥å…· v4.0 - ç»ˆæç‰ˆ
          
          ### ğŸ‰ v4.0 ç»ˆæç‰ˆ - é©å‘½æ€§å‡çº§
          - ğŸ” **æ‰©å¤§å…³é”®è¯æœç´¢** - æ”¯æŒæ›´å¤šå°å•†å“ç±»åˆ«æœç´¢
          - â™¾ï¸ **æ— é™åˆ¶è¿ç»­æœç´¢** - æƒ³æœå¤šä¹…æœå¤šä¹…ï¼Œä¸è®¾ä¸Šé™
          - ğŸ’¾ **å®æ—¶ä¿å­˜åŠŸèƒ½** - ä¸€è¾¹æœç´¢ä¸€è¾¹ä¿å­˜ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
          - ğŸ§  **å››å±‚æ™ºèƒ½æå–** - å–å®¶ä¿¡æ¯æå–å‡†ç¡®ç‡å¤§å¹…æå‡
          - ğŸ–¥ï¸ **åå°è¿è¡Œæ”¯æŒ** - å¯ä»¥ç¦»å¼€æ¡Œé¢ï¼Œç¨‹åºç»§ç»­å·¥ä½œ
          - ğŸŒ **ä¸­æ–‡åˆ—åæ”¯æŒ** - Excelè¡¨æ ¼æ˜¾ç¤ºä¸­æ–‡åˆ—å
          
          ### ğŸ†š ç‰ˆæœ¬å¯¹æ¯”
          | åŠŸèƒ½ | v3.1 | v4.0 | æ”¹è¿› |
          |------|------|------|------|
          | æœç´¢é™åˆ¶ | æœ‰é¡µæ•°é™åˆ¶ | æ— é™åˆ¶æœç´¢ | **çªç ´é™åˆ¶** |
          | ä¿å­˜æ–¹å¼ | æœç´¢å®Œæ‰ä¿å­˜ | å®æ—¶ä¿å­˜ | **é˜²ä¸¢å¤±** |
          | å…³é”®è¯è¦†ç›– | éƒ¨åˆ†å•†å“ | å…¨å“ç±»æ”¯æŒ | **å…¨è¦†ç›–** |
          | å–å®¶æå– | ä¸‰å±‚ç®—æ³• | å››å±‚æ™ºèƒ½ç®—æ³• | **æ›´å‡†ç¡®** |
          | åå°è¿è¡Œ | ä¸æ”¯æŒ | å®Œå…¨æ”¯æŒ | **æ›´çµæ´»** |
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - ä¸‹è½½ `Amazon_Japan_Scraper_v4.0_Ultimate.exe` æ–‡ä»¶
          - åŒå‡»è¿è¡Œå³å¯ä½¿ç”¨ï¼Œæ— éœ€å®‰è£…
          - æ”¯æŒ Windows 10 åŠä»¥ä¸Šç‰ˆæœ¬
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. å¯åŠ¨ç¨‹åº
          2. è¾“å…¥ä»»æ„å•†å“å…³é”®è¯ï¼ˆå¦‚ï¼šæ‰‹æœºå£³ã€æ•°æ®çº¿ã€å°å•†å“ï¼‰
          3. ç‚¹å‡»"å¼€å§‹æ— é™æœç´¢"
          4. ç¨‹åºè‡ªåŠ¨æœç´¢å¹¶å®æ—¶ä¿å­˜
          5. å¯éšæ—¶åœæ­¢ï¼Œæ•°æ®å·²ä¿å­˜
          6. æ”¯æŒåå°è¿è¡Œï¼Œå¯ç¦»å¼€æ¡Œé¢
          
          ### ğŸ¯ æ ¸å¿ƒç‰¹æ€§
          - **æ— é™æœç´¢**: ä¸è®¾é¡µæ•°å’Œäº§å“æ•°é™åˆ¶
          - **å®æ—¶ä¿å­˜**: æ¯50ä¸ªäº§å“è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
          - **æ™ºèƒ½å»é‡**: è‡ªåŠ¨è¿‡æ»¤é‡å¤äº§å“å’Œå–å®¶
          - **å››å±‚æå–**: å…³é”®è¯+ç»“æ„+æ­£åˆ™+æ·±åº¦åˆ†æ
          - **å…¨å“ç±»æ”¯æŒ**: ä»å¤§ä»¶åˆ°å°å•†å“å…¨è¦†ç›–
          
          ### ğŸ›¡ï¸ ç¨³å®šæ€§ä¿è¯
          - æ™ºèƒ½å»¶è¿Ÿæ§åˆ¶ï¼Œé¿å…è¢«å°
          - å¹¶å‘å¤„ç†ä¼˜åŒ–ï¼Œæé«˜æ•ˆç‡
          - å†…å­˜è‡ªåŠ¨ç®¡ç†ï¼Œé•¿æœŸç¨³å®šè¿è¡Œ
          - é”™è¯¯è‡ªåŠ¨æ¢å¤ï¼Œå•ä¸ªå¤±è´¥ä¸å½±å“æ•´ä½“
          
          ### ğŸ“Š æå–å­—æ®µ
          **äº§å“ä¿¡æ¯**: æ ‡é¢˜ã€ä»·æ ¼ã€è¯„åˆ†ã€é“¾æ¥ç­‰
          **å–å®¶ä¿¡æ¯**: å…¬å¸åã€ç”µè¯ã€åœ°å€ã€ä»£è¡¨å§“åã€åº—é“ºåã€é‚®ç®±ã€ä¼ çœŸ
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - è¯·åˆç†ä½¿ç”¨ï¼Œéµå®ˆç½‘ç«™ä½¿ç”¨æ¡æ¬¾
          - æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨
          - å»ºè®®åœ¨ç½‘ç»œç¨³å®šæ—¶ä½¿ç”¨
          
          **ğŸŠ ç»ˆæç‰ˆæ¥äº†ï¼æ— é™æœç´¢ï¼Œå®æ—¶ä¿å­˜ï¼Œæ™ºèƒ½æå–ï¼Œåå°è¿è¡Œï¼**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
