name: Build Amazon Japan Scraper v5.0

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-v5:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Install Chrome for Selenium
      run: |
        choco install googlechrome -y --force
        
    - name: Test imports for v5.0
      run: |
        python -c "import tkinter; import requests; import bs4; import pandas; import openpyxl; import selenium; import undetected_chromedriver; print('All imports successful for v5.0')"
        
    - name: Test v5.0 Selenium version
      run: |
        python -c "from main_selenium_only import SeleniumOnlyScraper, SeleniumOnlyGUI; print('v5.0 Selenium version imports successful')"
        
    - name: Build v5.0 executable
      run: |
        python build_v5.py
        
    - name: Debug - List dist directory
      run: |
        Write-Host "Contents of dist directory:"
        Get-ChildItem -Path "dist" -Force | Format-Table Name, Length, LastWriteTime
        
    - name: Verify build results
      run: |
        # The build script should have created the release_v5 directory
        if (Test-Path "release_v5") {
          Write-Host "âœ… Release directory created by build script"
          Write-Host "ğŸ“ Contents of release_v5:"
          Get-ChildItem -Path "release_v5" | Format-Table Name, Length, LastWriteTime
          
          # Check for the expected executable
          $exePath = "release_v5\Amazon_Japan_Scraper_v5.0_Selenium.exe"
          if (Test-Path $exePath) {
            Write-Host "âœ… Windows executable found: $exePath"
            $fileInfo = Get-Item $exePath
            Write-Host "ğŸ“Š File size: $([math]::Round($fileInfo.Length / 1MB, 1)) MB"
          } else {
            Write-Host "âŒ Expected executable not found in release directory"
            exit 1
          }
        } else {
          Write-Host "âŒ Release directory not created by build script"
          exit 1
        }
        
    - name: Final verification
      run: |
        if (Test-Path "release_v5/Amazon_Japan_Scraper_v5.0_Selenium.exe") {
          Write-Host "ğŸ‰ v5.0 Selenium Edition build completed successfully!"
          $size = (Get-Item "release_v5/Amazon_Japan_Scraper_v5.0_Selenium.exe").Length / 1MB
          Write-Host "ğŸ“Š Final file size: $([math]::Round($size, 1)) MB"
          Write-Host "âœ… Ready for distribution"
        } else {
          Write-Host "âŒ Final verification failed - executable not found"
          exit 1
        }
        
    - name: Upload v5.0 build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Amazon-Japan-Scraper-v5.0-Selenium
        path: release_v5/
        retention-days: 30
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release_v5/Amazon_Japan_Scraper_v5.0_Selenium.exe
          release_v5/README.txt
        body: |
          ## ğŸš€ Amazon Japan Scraper v5.0 - Selenium Edition
          
          ### ğŸ‰ v5.0 é‡å¤§å‡çº§ - çº¯Seleniumå®ç°
          
          **æ ¸å¿ƒæ”¹è¿›**:
          - ğŸŒ **å®Œå…¨åŸºäºSelenium** - ä½¿ç”¨undetected-chromedriverç»•è¿‡åçˆ¬è™«
          - ğŸ¯ **93%å–å®¶è¯†åˆ«ç‡** - å¤§å¹…æå‡æ•°æ®æå–æˆåŠŸç‡
          - ğŸ“ **å¢å¼ºç”µè¯æå–** - æ”¯æŒä¸­æ—¥åŒè¯­ç”µè¯å·ç æ ¼å¼
          - ğŸ¢ **å®Œæ•´å–å®¶ä¿¡æ¯** - å…¬å¸åã€åœ°å€ã€ç”µè¯ã€é‚®ç®±ç­‰
          - ğŸ‡¨ğŸ‡³ **ä¸­æ–‡åˆ—å** - Excelè¡¨æ ¼ä½¿ç”¨ä¸­æ–‡åˆ—å¤´
          - ğŸ’ª **ç¨³å®šå¯é ** - æˆåŠŸç»•è¿‡Amazonåçˆ¬æœºåˆ¶
          
          ### ğŸ“Š æµ‹è¯•æ•°æ®ï¼ˆåŸºäº15ä¸ªäº§å“å®æµ‹ï¼‰
          - **å–å®¶è¯†åˆ«ç‡**: 93% (14/15)
          - **åœ°å€æå–ç‡**: 73% (11/15)
          - **ç”µè¯æå–ç‡**: 20% (3/15) - å–å†³äºå–å®¶æ˜¯å¦å…¬å¼€
          - **å…¬å¸åæå–ç‡**: 93% (14/15)
          - **å¹³å‡é€Ÿåº¦**: 8-10ç§’/äº§å“
          
          ### ğŸ†š ç‰ˆæœ¬å¯¹æ¯”
          | åŠŸèƒ½ | v4.0 Ultimate | v5.0 Selenium | æ”¹è¿› |
          |------|---------------|---------------|------|
          | æ ¸å¿ƒæŠ€æœ¯ | HTTP + requests | Selenium + undetected-chromedriver | **çªç ´åçˆ¬** |
          | å–å®¶è¯†åˆ«ç‡ | ~60% | 93% | **+55%** |
          | åœ°å€æå–ç‡ | ~40% | 73% | **+83%** |
          | ç”µè¯æå–ç‡ | ~5% | 20% | **+300%** |
          | ç¨³å®šæ€§ | ç»å¸¸503é”™è¯¯ | ç¨³å®šè¿è¡Œ | **å®Œå…¨è§£å†³** |
          | æœç´¢æˆåŠŸç‡ | ~30% | ~95% | **+217%** |
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - ä¸‹è½½ `Amazon_Japan_Scraper_v5.0_Selenium.exe` æ–‡ä»¶
          - åŒå‡»è¿è¡Œå³å¯ä½¿ç”¨ï¼Œæ— éœ€å®‰è£…
          - éœ€è¦Google Chromeæµè§ˆå™¨ï¼ˆç¨‹åºä¼šè‡ªåŠ¨ä½¿ç”¨æ— å¤´æ¨¡å¼ï¼‰
          - æ”¯æŒ Windows 10 åŠä»¥ä¸Šç‰ˆæœ¬
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. å¯åŠ¨ç¨‹åºï¼ˆé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½ChromeDriverï¼‰
          2. è¾“å…¥å•†å“å…³é”®è¯ï¼ˆå¦‚ï¼šiPhone æ‰‹æœºå£³ã€å£çº¢ã€è¡Œæç®±ï¼‰
          3. è®¾ç½®æœç´¢é¡µæ•°å’Œäº§å“æ•°é‡
          4. ç‚¹å‡»"å¼€å§‹æœç´¢"
          5. ç¨‹åºè‡ªåŠ¨æœç´¢å¹¶å®æ—¶ä¿å­˜
          6. ç»“æœä¿å­˜åœ¨ amazon_data/ æ–‡ä»¶å¤¹
          
          ### ğŸ¯ æ ¸å¿ƒç‰¹æ€§
          - **çœŸæµè§ˆå™¨æŠ€æœ¯**: ä½¿ç”¨çœŸå®Chromeæµè§ˆå™¨ï¼Œå®Œå…¨æ¨¡æ‹Ÿäººç±»è¡Œä¸º
          - **åçˆ¬è™«ç»•è¿‡**: undetected-chromedriveræŠ€æœ¯ï¼ŒæˆåŠŸç‡95%+
          - **å®æ—¶ä¿å­˜**: æœç´¢è¿‡ç¨‹ä¸­å®æ—¶ä¿å­˜ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
          - **æ™ºèƒ½æå–**: 4å±‚æå–ç®—æ³•ï¼Œè¦†ç›–å„ç§å–å®¶é¡µé¢ç»“æ„
          - **ä¸­æ–‡å‹å¥½**: Excelåˆ—åå…¨éƒ¨ä¸­æ–‡æ˜¾ç¤º
          - **å¤šæ ¼å¼æ”¯æŒ**: æ”¯æŒä¸­å›½å’Œæ—¥æœ¬ç”µè¯å·ç æ ¼å¼
          
          ### ğŸ“Š æå–å­—æ®µ
          **äº§å“ä¿¡æ¯**:
          - äº§å“æ ‡é¢˜ã€ä»·æ ¼ã€è¯„åˆ†ã€ASINã€äº§å“é“¾æ¥
          
          **å–å®¶ä¿¡æ¯**:
          - å–å®¶åç§°ã€å…¬å¸åç§°ã€ç”µè¯å·ç ã€å®Œæ•´åœ°å€
          - ç”µå­é‚®ç®±ã€ä¼ çœŸå·ç ã€åº—é“ºåç§°ã€ä»£è¡¨å§“åï¼ˆå¦‚æœ‰ï¼‰
          
          ### âš™ï¸ æ¨èé…ç½®
          - **å¿«é€Ÿæµ‹è¯•**: 1é¡µï¼Œ10äº§å“ï¼ˆçº¦1-2åˆ†é’Ÿï¼‰
          - **ä¸­ç­‰è§„æ¨¡**: 3é¡µï¼Œ30äº§å“ï¼ˆçº¦5-8åˆ†é’Ÿï¼‰
          - **å¤§è§„æ¨¡**: 5-10é¡µï¼Œ50-100äº§å“ï¼ˆçº¦15-30åˆ†é’Ÿï¼‰
          
          ### ğŸ›¡ï¸ ç¨³å®šæ€§ä¿è¯
          - æ™ºèƒ½å»¶è¿Ÿæ§åˆ¶ï¼Œé¿å…è¢«å°
          - ä¼šè¯ç®¡ç†ä¼˜åŒ–ï¼Œé•¿æœŸç¨³å®šè¿è¡Œ
          - é”™è¯¯è‡ªåŠ¨æ¢å¤ï¼Œå•ä¸ªå¤±è´¥ä¸å½±å“æ•´ä½“
          - å†…å­˜è‡ªåŠ¨æ¸…ç†ï¼Œä¸ä¼šæº¢å‡º
          
          ### ğŸ’¡ ä½¿ç”¨å»ºè®®
          - å»ºè®®æ¯æ¬¡æœç´¢ä¸è¶…è¿‡100ä¸ªäº§å“ï¼Œä»¥ä¿è¯æœ€ä½³æ€§èƒ½
          - ç”µè¯å·ç æå–ç‡å› å–å®¶éšç§è®¾ç½®è€Œå¼‚ï¼ˆ20%æ˜¯æ­£å¸¸æ°´å¹³ï¼‰
          - å¦‚éœ€å¤§é‡æ•°æ®ï¼Œå»ºè®®åˆ†æ‰¹æ¬¡è¿è¡Œ
          - ç½‘ç»œç¨³å®šæ—¶ä½¿ç”¨æ•ˆæœæœ€ä½³
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œéœ€è¦ä¸‹è½½ChromeDriverï¼ˆçº¦10-20MBï¼‰
          - ç¨‹åºä½¿ç”¨æ— å¤´Chromeæµè§ˆå™¨ï¼Œä¸ä¼šæ‰“å¼€å¯è§çª—å£
          - è¯·åˆç†ä½¿ç”¨ï¼Œéµå®ˆAmazonä½¿ç”¨æ¡æ¬¾
          - æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨
          
          **ğŸŠ v5.0æ¥äº†ï¼çº¯Seleniumå®ç°ï¼Œ93%è¯†åˆ«ç‡ï¼Œç¨³å®šå¯é ï¼**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
