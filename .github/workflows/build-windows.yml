name: Build Amazon Japan Scraper v4.0

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ultimate:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Test imports for ultimate version
      run: |
        python -c "import tkinter; import requests; import bs4; import pandas; import openpyxl; print('All imports successful for v4.0')"
        
    - name: Test ultimate version
      run: |
        python -c "from main_ultimate import UltimateAmazonScraper, UltimateScraperGUI; print('Ultimate version imports successful')"
        
    - name: Build ultimate executable
      run: |
        pyinstaller --onefile --windowed --name=Amazon_Japan_Scraper_v4.0_Ultimate --hidden-import=tkinter --hidden-import=tkinter.ttk --hidden-import=requests --hidden-import=bs4 --hidden-import=pandas --hidden-import=openpyxl --hidden-import=concurrent.futures --hidden-import=urllib3 --exclude-module=matplotlib --exclude-module=scipy --clean main_ultimate.py
        
    - name: Debug - List dist directory
      run: |
        Write-Host "Contents of dist directory:"
        Get-ChildItem -Path "dist" -Force | Format-Table Name, Length, LastWriteTime
        
    - name: Create release directory
      run: |
        New-Item -ItemType Directory -Force -Path "release_ultimate"
        
        # Try to find the executable with or without .exe extension
        if (Test-Path "dist\Amazon_Japan_Scraper_v4.0_Ultimate.exe") {
          Write-Host "Found .exe file, copying..."
          Copy-Item "dist\Amazon_Japan_Scraper_v4.0_Ultimate.exe" "release_ultimate\Amazon_Japan_Scraper_v4.0_Ultimate.exe"
        } elseif (Test-Path "dist\Amazon_Japan_Scraper_v4.0_Ultimate") {
          Write-Host "Found file without .exe extension, copying and renaming..."
          Copy-Item "dist\Amazon_Japan_Scraper_v4.0_Ultimate" "release_ultimate\Amazon_Japan_Scraper_v4.0_Ultimate.exe"
        } else {
          Write-Host "ERROR: No executable found in dist directory"
          exit 1
        }
        
    - name: Create README for release
      run: |
        $readmeContent = @"
        # Amazon Japan Scraper v4.0 - ç»ˆæç‰ˆ

        ## ğŸš€ v4.0 ç»ˆæç‰ˆç‰¹æ€§
        - ğŸ” æ‰©å¤§å…³é”®è¯æœç´¢èŒƒå›´ï¼Œæ”¯æŒæ›´å¤šå°å•†å“
        - â™¾ï¸ æ— é™åˆ¶è¿ç»­æœç´¢ï¼Œæƒ³æœå¤šä¹…æœå¤šä¹…
        - ğŸ’¾ å®æ—¶ä¿å­˜åŠŸèƒ½ï¼Œä¸€è¾¹æœç´¢ä¸€è¾¹ä¿å­˜æ•°æ®
        - ğŸ§  å››å±‚æ™ºèƒ½å–å®¶ä¿¡æ¯æå–ç®—æ³•
        - ğŸ–¥ï¸ æ”¯æŒåå°è¿è¡Œï¼Œå¯ä»¥ç¦»å¼€æ¡Œé¢

        ## ğŸš€ ä½¿ç”¨æ–¹æ³•
        1. åŒå‡»è¿è¡Œç¨‹åº
        2. è¾“å…¥æœç´¢å…³é”®è¯ï¼ˆå¦‚ï¼šç”µè„‘ã€ç¬”è®°æœ¬ã€æ‰‹æœºï¼‰
        3. è®¾ç½®é¡µæ•°å’Œäº§å“æ•°é‡
        4. ç‚¹å‡»å¼€å§‹æœç´¢

        ## âš™ï¸ æ¨èé…ç½®
        - å°è§„æ¨¡æµ‹è¯•ï¼š20é¡µï¼Œ100äº§å“
        - ä¸­ç­‰è§„æ¨¡ï¼š50é¡µï¼Œ500äº§å“  
        - å¤§è§„æ¨¡ï¼š100é¡µï¼Œ2000äº§å“

        ## ğŸ›¡ï¸ ç¨³å®šæ€§ä¿è¯
        - åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹20ä¸ªäº§å“
        - å†…å­˜è‡ªåŠ¨æ¸…ç†ï¼Œä¸ä¼šæº¢å‡º
        - é”™è¯¯è‡ªåŠ¨æ¢å¤ï¼Œå•ä¸ªå¤±è´¥ä¸å½±å“æ•´ä½“

        ç‰ˆæœ¬: 3.0.0 - ç®€åŒ–é«˜æ€§èƒ½ç‰ˆ
        "@
        $readmeContent | Out-File -FilePath "release_ultimate\README.txt" -Encoding UTF8
        
    - name: Verify ultimate build
      run: |
        if (Test-Path "release_ultimate/Amazon_Japan_Scraper_v4.0_Ultimate.exe") {
          Write-Host "âœ… Ultimate v4.0 executable built successfully"
          $size = (Get-Item "release_ultimate/Amazon_Japan_Scraper_v4.0_Ultimate.exe").Length / 1MB
          Write-Host "ğŸ“Š File size: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "âŒ Ultimate executable not found"
          exit 1
        }
        
    - name: Upload ultimate build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Amazon-Japan-Scraper-v4.0-Ultimate
        path: release_simplified/
        retention-days: 30
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release_simplified/Amazon_Japan_Scraper_v3.1_Enhanced.exe
          release_simplified/README.txt
        body: |
          ## ğŸš€ Amazon Japan å–å®¶ä¿¡æ¯æå–å·¥å…· v3.1 - å¢å¼ºæå–ç‰ˆ
          
          ### ğŸ‰ é‡å¤§æ›´æ–° - å½»åº•é‡æ„
          - âœ… **è§£å†³æœªå“åº”é—®é¢˜** - åˆ†æ‰¹å¤„ç†ï¼Œæ°¸ä¸é˜»å¡
          - âœ… **ç®€åŒ–ä¸šåŠ¡é€»è¾‘** - ç§»é™¤å¤æ‚åˆ†ç±»ï¼Œç›´æ¥å…³é”®è¯æœç´¢
          - âœ… **æ”¯æŒå¤§è§„æ¨¡æ•°æ®** - æœ€å¤š100é¡µï¼Œ10000ä¸ªäº§å“
          - âœ… **å†…å­˜ä¼˜åŒ–** - åˆ†æ‰¹å¤„ç†ï¼Œç¨³å®šè¿è¡Œä¸å´©æºƒ
          - âœ… **æç®€ç”¨æˆ·ç•Œé¢** - åªéœ€è¾“å…¥å…³é”®è¯å³å¯æœç´¢
          
          ### ğŸ†š ç‰ˆæœ¬å¯¹æ¯”
          | åŠŸèƒ½ | v2.0 | v3.0 | æ”¹è¿› |
          |------|------|------|------|
          | æœ€å¤§äº§å“æ•° | 5000ä¸ª | 10000ä¸ª | **2å€æå‡** |
          | æœ€å¤§é¡µæ•° | 50é¡µ | 100é¡µ | **2å€æå‡** |
          | å†…å­˜ä½¿ç”¨ | æŒç»­å¢é•¿â†’å´©æºƒ | ç¨³å®š<300MB | **ä¸å´©æºƒ** |
          | æœç´¢æ–¹å¼ | å¤æ‚åˆ†ç±» | ç›´æ¥å…³é”®è¯ | **æ›´ç®€å•** |
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - ä¸‹è½½ `Amazon_Japan_Scraper_v3.0_Simplified.exe` æ–‡ä»¶
          - åŒå‡»è¿è¡Œå³å¯ä½¿ç”¨ï¼Œæ— éœ€å®‰è£…
          - æ”¯æŒ Windows 10 åŠä»¥ä¸Šç‰ˆæœ¬
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. å¯åŠ¨ç¨‹åº
          2. è¾“å…¥æœç´¢å…³é”®è¯ï¼ˆå¦‚ï¼šç”µè„‘ã€ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³ã€ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ï¼‰
          3. è®¾ç½®é¡µæ•°å’Œäº§å“æ•°é‡ï¼ˆæ¨èï¼š20é¡µï¼Œ1000äº§å“ï¼‰
          4. ç‚¹å‡»"ğŸš€ å¼€å§‹æœç´¢"
          5. å®æ—¶æŸ¥çœ‹è¿›åº¦ï¼Œå¯éšæ—¶åœæ­¢
          6. å®Œæˆåå¯¼å‡ºExcel/CSVæ•°æ®
          
          ### âš™ï¸ æ¨èé…ç½®
          - **æ–°æ‰‹æµ‹è¯•**: 20é¡µï¼Œ100äº§å“ï¼Œå¹¶å‘3
          - **æ—¥å¸¸ä½¿ç”¨**: 50é¡µï¼Œ500äº§å“ï¼Œå¹¶å‘3  
          - **å¤§è§„æ¨¡å¤„ç†**: 100é¡µï¼Œ2000äº§å“ï¼Œå¹¶å‘3
          
          ### ğŸ›¡ï¸ ç¨³å®šæ€§ä¿è¯
          - åˆ†æ‰¹å¤„ç†æŠ€æœ¯ï¼Œæ¯æ‰¹20ä¸ªäº§å“
          - è‡ªåŠ¨å†…å­˜æ¸…ç†ï¼Œé˜²æ­¢æº¢å‡º
          - æ™ºèƒ½é”™è¯¯æ¢å¤ï¼Œå•ä¸ªå¤±è´¥ä¸å½±å“æ•´ä½“
          - å®æ—¶è¿›åº¦åé¦ˆï¼Œå¯éšæ—¶åœæ­¢
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - è¯·åˆç†ä½¿ç”¨ï¼Œéµå®ˆç½‘ç«™ä½¿ç”¨æ¡æ¬¾
          - æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨
          - å»ºè®®åœ¨ç½‘ç»œç¨³å®šæ—¶ä½¿ç”¨
          
          **ğŸŠ å‘Šåˆ«å´©æºƒï¼Œæ‹¥æŠ±ç¨³å®šï¼ç°åœ¨å¯ä»¥è½»æ¾å¤„ç†10000+äº§å“ï¼**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
