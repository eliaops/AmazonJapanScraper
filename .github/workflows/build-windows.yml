name: Build Amazon Japan Scraper v4.0

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ultimate:
    runs-on: windows-2022
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Test imports for ultimate version
      run: |
        python -c "import tkinter; import requests; import bs4; import pandas; import openpyxl; print('All imports successful for v4.0')"
        
    - name: Test ultimate version
      run: |
        python -c "from main_ultimate import UltimateAmazonScraper, UltimateScraperGUI; print('Ultimate version imports successful')"
        
    - name: Build ultimate executable
      run: |
        pyinstaller --onefile --windowed --name=Amazon_Japan_Scraper_v4.0_Ultimate --hidden-import=tkinter --hidden-import=tkinter.ttk --hidden-import=requests --hidden-import=bs4 --hidden-import=pandas --hidden-import=openpyxl --hidden-import=concurrent.futures --hidden-import=urllib3 --exclude-module=matplotlib --exclude-module=scipy --clean main_ultimate.py
        
    - name: Debug - List dist directory
      run: |
        Write-Host "Contents of dist directory:"
        Get-ChildItem -Path "dist" -Force | Format-Table Name, Length, LastWriteTime
        
    - name: Create release directory
      run: |
        New-Item -ItemType Directory -Force -Path "release_ultimate"
        
        # Try to find the executable with or without .exe extension
        if (Test-Path "dist\Amazon_Japan_Scraper_v4.0_Ultimate.exe") {
          Write-Host "Found .exe file, copying..."
          Copy-Item "dist\Amazon_Japan_Scraper_v4.0_Ultimate.exe" "release_ultimate\Amazon_Japan_Scraper_v4.0_Ultimate.exe"
        } elseif (Test-Path "dist\Amazon_Japan_Scraper_v4.0_Ultimate") {
          Write-Host "Found file without .exe extension, copying and renaming..."
          Copy-Item "dist\Amazon_Japan_Scraper_v4.0_Ultimate" "release_ultimate\Amazon_Japan_Scraper_v4.0_Ultimate.exe"
        } else {
          Write-Host "ERROR: No executable found in dist directory"
          exit 1
        }
        
    - name: Create README for release
      run: |
        $readmeContent = @"
        # Amazon Japan Scraper v4.0 - 终极版

        ## 🚀 v4.0 终极版特性
        - 🔍 扩大关键词搜索范围，支持更多小商品
        - ♾️ 无限制连续搜索，想搜多久搜多久
        - 💾 实时保存功能，一边搜索一边保存数据
        - 🧠 四层智能卖家信息提取算法
        - 🖥️ 支持后台运行，可以离开桌面

        ## 🚀 使用方法
        1. 双击运行程序
        2. 输入搜索关键词（如：电脑、笔记本、手机）
        3. 设置页数和产品数量
        4. 点击开始搜索

        ## ⚙️ 推荐配置
        - 小规模测试：20页，100产品
        - 中等规模：50页，500产品  
        - 大规模：100页，2000产品

        ## 🛡️ 稳定性保证
        - 分批处理，每批20个产品
        - 内存自动清理，不会溢出
        - 错误自动恢复，单个失败不影响整体

        版本: 3.0.0 - 简化高性能版
        "@
        $readmeContent | Out-File -FilePath "release_ultimate\README.txt" -Encoding UTF8
        
    - name: Verify ultimate build
      run: |
        if (Test-Path "release_ultimate/Amazon_Japan_Scraper_v4.0_Ultimate.exe") {
          Write-Host "✅ Ultimate v4.0 executable built successfully"
          $size = (Get-Item "release_ultimate/Amazon_Japan_Scraper_v4.0_Ultimate.exe").Length / 1MB
          Write-Host "📊 File size: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "❌ Ultimate executable not found"
          exit 1
        }
        
    - name: Upload ultimate build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Amazon-Japan-Scraper-v4.0-Ultimate
        path: release_simplified/
        retention-days: 30
        
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release_simplified/Amazon_Japan_Scraper_v3.1_Enhanced.exe
          release_simplified/README.txt
        body: |
          ## 🚀 Amazon Japan 卖家信息提取工具 v3.1 - 增强提取版
          
          ### 🎉 重大更新 - 彻底重构
          - ✅ **解决未响应问题** - 分批处理，永不阻塞
          - ✅ **简化业务逻辑** - 移除复杂分类，直接关键词搜索
          - ✅ **支持大规模数据** - 最多100页，10000个产品
          - ✅ **内存优化** - 分批处理，稳定运行不崩溃
          - ✅ **极简用户界面** - 只需输入关键词即可搜索
          
          ### 🆚 版本对比
          | 功能 | v2.0 | v3.0 | 改进 |
          |------|------|------|------|
          | 最大产品数 | 5000个 | 10000个 | **2倍提升** |
          | 最大页数 | 50页 | 100页 | **2倍提升** |
          | 内存使用 | 持续增长→崩溃 | 稳定<300MB | **不崩溃** |
          | 搜索方式 | 复杂分类 | 直接关键词 | **更简单** |
          
          ### 📦 下载说明
          - 下载 `Amazon_Japan_Scraper_v3.0_Simplified.exe` 文件
          - 双击运行即可使用，无需安装
          - 支持 Windows 10 及以上版本
          
          ### 🚀 使用方法
          1. 启动程序
          2. 输入搜索关键词（如：电脑、ノートパソコン、スマートフォン）
          3. 设置页数和产品数量（推荐：20页，1000产品）
          4. 点击"🚀 开始搜索"
          5. 实时查看进度，可随时停止
          6. 完成后导出Excel/CSV数据
          
          ### ⚙️ 推荐配置
          - **新手测试**: 20页，100产品，并发3
          - **日常使用**: 50页，500产品，并发3  
          - **大规模处理**: 100页，2000产品，并发3
          
          ### 🛡️ 稳定性保证
          - 分批处理技术，每批20个产品
          - 自动内存清理，防止溢出
          - 智能错误恢复，单个失败不影响整体
          - 实时进度反馈，可随时停止
          
          ### ⚠️ 注意事项
          - 请合理使用，遵守网站使用条款
          - 数据仅供学习和研究使用
          - 建议在网络稳定时使用
          
          **🎊 告别崩溃，拥抱稳定！现在可以轻松处理10000+产品！**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
